<!DOCTYPE html>
<html>
<head>
  <script src="face-api.js"></script>
  <script src="js/commons.js"></script>
  <script src="js/faceDetectionControls.js"></script>
  <script src="js/imageSelectionControls.js"></script>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.css">
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
</head>
<body>
  <div class="center-content page-container">
    <div class="row side-by-side">
    <div style="position: relative" class="margin">
      <img id="inputImg" src="" style="max-width: 800px;" />
      <canvas id="overlay" />
    </div>
    <ul id="afbeeldingdetails">
    </ul>
    </div>

    <div class="row side-by-side">
    <!-- face_detector_selection_control -->
    <div id="face_detector_selection_control" class="row input-field" style="margin-right: 20px;">
      <select id="selectFaceDetector">
        <option value="ssd_mobilenetv1">SSD Mobilenet V1</option>
        <option value="tiny_face_detector">Tiny Face Detector</option>
        <option value="mtcnn">MTCNN</option>
      </select>
      <label>Selecteer gezichtsdetector</label>
    </div>
    <!-- face_detector_selection_control -->
  </div>

  <!-- image_selection_control -->
  <div class="row">
      <label>Afbeelding uploaden:</label>
      <div>
        <input id="ImgUploadInput" type="file" class="bold" onchange="uploadImage()" accept=".jpg, .jpeg, .png">
      </div>
    </div>
    <!-- image_selection_control -->

<!-- localImage_selection_control -->
<div class="row">
    <label for="selectList">Lokale afbeelding:</label>
    <div id="selectList"></div>
  </div>
    <button
      class="waves-effect waves-light btn"
      onclick="loadLocalImageFromSelection()"
    >
      Ok
    </button>
    <!-- localImage_selection_control -->

    <div class="row side-by-side">
      <!-- image_selection_control -->
      <div class="row">
        <label for="imgUrlInput">Afbeelding-URL:</label>
        <input id="imgUrlInput" type="text" class="bold">
      </div>
      <button
        class="waves-effect waves-light btn"
        onclick="loadImageFromUrl()"
      >
        Ok
      </button>
      <!-- image_selection_control -->
    </div>
    
    <!-- ssd_mobilenetv1_controls --><!--
    <span id="ssd_mobilenetv1_controls">
      <div class="row side-by-side">
        <div class="row">
          <label for="minConfidence">Min Confidence:</label>
          <input disabled value="0.5" id="minConfidence" type="text" class="bold">
        </div>
        <button
          class="waves-effect waves-light btn"
          onclick="onDecreaseMinConfidence()"
        >
          <i class="material-icons left">-</i>
        </button>
        <button
          class="waves-effect waves-light btn"
          onclick="onIncreaseMinConfidence()"
        >
          <i class="material-icons left">+</i>
        </button>
      </div>
    </span> -->
    <!-- ssd_mobilenetv1_controls -->

    <!-- tiny_face_detector_controls --><!--
    <span id="tiny_face_detector_controls">
      <div class="row side-by-side">
        <div class="row input-field" style="margin-right: 20px;">
          <select id="inputSize">
            <option value="" disabled selected>Input Size:</option>
            <option value="160">160 x 160</option>
            <option value="224">224 x 224</option>
            <option value="320">320 x 320</option>
            <option value="416">416 x 416</option>
            <option value="512">512 x 512</option>
            <option value="608">608 x 608</option>
          </select>
          <label>Input Size</label>
        </div>
        <div class="row">
          <label for="scoreThreshold">Score Threshold:</label>
          <input disabled value="0.5" id="scoreThreshold" type="text" class="bold">
        </div>
        <button
          class="waves-effect waves-light btn"
          onclick="onDecreaseScoreThreshold()"
        >
          <i class="material-icons left">-</i>
        </button>
        <button
          class="waves-effect waves-light btn"
          onclick="onIncreaseScoreThreshold()"
        >
          <i class="material-icons left">+</i>
        </button>
      </div>
    </span> -->
    <!-- tiny_face_detector_controls -->

    <!-- mtcnn_controls --><!--
    <span id="mtcnn_controls">
      <div class="row side-by-side">
        <div class="row">
          <label for="minFaceSize">Minimum Face Size:</label>
          <input disabled value="20" id="minFaceSize" type="text" class="bold">
        </div>
        <button
          class="waves-effect waves-light btn"
          onclick="onDecreaseMinFaceSize()"
        >
          <i class="material-icons left">-</i>
        </button>
        <button
          class="waves-effect waves-light btn"
          onclick="onIncreaseMinFaceSize()"
        >
          <i class="material-icons left">+</i>
        </button>
      </div>
    </span> -->
    <!-- mtcnn_controls -->
  
  </body>

  <script>
    async function updateResults() {
      if (!isFaceDetectionModelLoaded()) {
        return
      }

      const inputImgEl = $('#inputImg').get(0)
      const options = getFaceDetectorOptions()

      const minConfidence = 0.05 //For expressions

      const results = await faceapi.detectAllFaces(inputImgEl, options)
      .withFaceLandmarks()
      .withFaceDescriptors()
      .withFaceExpressions()
      .withAgeAndGender()

      var faceExpressions = await mapAllExpressions(results)

      var genders = await mapAllGenders(results)

      //clear image details
      clearImageDetailList()

      //Voeg aantal personen toe aan detailoverzicht
      createImageDetail("Aantal gevonden personen", results.length)

      //Voeg expressies toe aan detailoverzicht
      faceExpressions.forEach(printMapItems)

      //Voeg genders toe aan detailoverzicht
      genders.forEach(printMapItems)

      //Draw
      const canvas = $('#overlay').get(0)
      faceapi.matchDimensions(canvas, inputImgEl)

      fullFaceDescriptions = faceapi.resizeResults(results, inputImgEl)

      faceapi.draw.drawDetections(canvas, fullFaceDescriptions)
      //faceapi.draw.drawFaceLandmarks(canvas, fullFaceDescriptions)
      faceapi.draw.drawFaceExpressions(canvas, fullFaceDescriptions, minConfidence)
    }

    async function run() {
      // load face detection
      await changeFaceDetector(SSD_MOBILENETV1)
      await faceapi.loadFaceLandmarkModel('/')
      await faceapi.loadFaceExpressionModel('/')
      await faceapi.loadFaceRecognitionModel('/')
      await faceapi.nets.ageGenderNet.load('/')

      // start processing image
      updateResults()
    }

    function clearImageDetailList()  
    { 
      const afbeeldingdetails = $('#afbeeldingdetails').get(0)

      while(afbeeldingdetails.firstChild) 
      afbeeldingdetails.removeChild(afbeeldingdetails.firstChild);
    } 

    function printMapItems(values, key)  
    { 
      createImageDetail(key, values)
    } 

    function createImageDetail(tag, value) {
      li = document.createElement('li');
      li.appendChild(document.createTextNode(tag + ": " + value));
      afbeeldingdetails.appendChild(li);
    }

    async function mapAllExpressions(faceExpressions) {
      var faceExpressionsMap = new Map([
            ["angry", 0],
            ["disgusted", 0],
            ["fearful", 0],
            ["happy", 0],
            ["neutral", 0],
            ["sad", 0],
            ["surprised", 0]
        ]);

      var faceExpressionsArray = Array.isArray(faceExpressions) ? faceExpressions : [faceExpressions];
        faceExpressionsArray.forEach(function (e) {
            var expression = Object.keys(e.expressions).reduce(function(a, b){ return e.expressions[a] > e.expressions[b] ? a : b });

            faceExpressionsMap.set(expression,(faceExpressionsMap.get(expression))+1);
        });

        return faceExpressionsMap
    }

    async function mapAllGenders(genders) {
      var gendersMap = new Map([
            ["male", 0],
            ["female", 0]
        ]);


      var gendersArray = Array.isArray(genders) ? genders : [genders];
      gendersArray.forEach(function (e) {

            gendersMap.set(e.gender,(gendersMap.get(e.gender))+1);
        });

        return gendersMap
    }

    async function uploadImage(e) {
      const imgFile = $('#ImgUploadInput').get(0).files[0]
      const img = await faceapi.bufferToImage(imgFile)

      $('#inputImg').get(0).src = img.src
      updateResults()
    }

    $(document).ready(function() {
      initImageSelectionControls()
      initFaceDetectionControls()
      run()
    })
  </script>
</body>
</html>